<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Problem Set 09</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Exercise_09_files/libs/clipboard/clipboard.min.js"></script>
<script src="Exercise_09_files/libs/quarto-html/quarto.js"></script>
<script src="Exercise_09_files/libs/quarto-html/popper.min.js"></script>
<script src="Exercise_09_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Exercise_09_files/libs/quarto-html/anchor.min.js"></script>
<link href="Exercise_09_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Exercise_09_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Exercise_09_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Exercise_09_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Exercise_09_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#foreword" id="toc-foreword" class="nav-link active" data-scroll-target="#foreword">Foreword</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul>
  <li><a href="#exercise-01-theoretical-foundations" id="toc-exercise-01-theoretical-foundations" class="nav-link" data-scroll-target="#exercise-01-theoretical-foundations">Exercise 01: Theoretical foundations</a>
  <ul class="collapse">
  <li><a href="#exercise-01a" id="toc-exercise-01a" class="nav-link" data-scroll-target="#exercise-01a">Exercise 01a:</a></li>
  <li><a href="#exercise-01b" id="toc-exercise-01b" class="nav-link" data-scroll-target="#exercise-01b">Exercise 01b :</a>
  <ul class="collapse">
  <li><a href="#exercise-01b-i" id="toc-exercise-01b-i" class="nav-link" data-scroll-target="#exercise-01b-i">Exercise 01b i:</a></li>
  <li><a href="#exercise-01b-ii" id="toc-exercise-01b-ii" class="nav-link" data-scroll-target="#exercise-01b-ii">Exercise 01b ii:</a></li>
  </ul></li>
  <li><a href="#exerice-01c" id="toc-exerice-01c" class="nav-link" data-scroll-target="#exerice-01c">Exerice 01c:</a></li>
  </ul></li>
  <li><a href="#exercise-02-neural-networks---toy-examples" id="toc-exercise-02-neural-networks---toy-examples" class="nav-link" data-scroll-target="#exercise-02-neural-networks---toy-examples">Exercise 02: Neural networks - toy examples</a>
  <ul class="collapse">
  <li><a href="#exerxise-02a" id="toc-exerxise-02a" class="nav-link" data-scroll-target="#exerxise-02a">Exerxise 02a:</a>
  <ul class="collapse">
  <li><a href="#exercise-02a-i" id="toc-exercise-02a-i" class="nav-link" data-scroll-target="#exercise-02a-i">Exercise 02a i:</a></li>
  <li><a href="#exercise-02a-ii" id="toc-exercise-02a-ii" class="nav-link" data-scroll-target="#exercise-02a-ii">Exercise 02a ii:</a></li>
  <li><a href="#exercise-02a-iii" id="toc-exercise-02a-iii" class="nav-link" data-scroll-target="#exercise-02a-iii">Exercise 02a iii:</a></li>
  </ul></li>
  <li><a href="#exercise-02b" id="toc-exercise-02b" class="nav-link" data-scroll-target="#exercise-02b">Exercise 02b:</a>
  <ul class="collapse">
  <li><a href="#exercise-02b-i" id="toc-exercise-02b-i" class="nav-link" data-scroll-target="#exercise-02b-i">Exercise 02b i:</a></li>
  <li><a href="#exercise-02-b-ii" id="toc-exercise-02-b-ii" class="nav-link" data-scroll-target="#exercise-02-b-ii">Exercise 02 b ii:</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#exercise-03" id="toc-exercise-03" class="nav-link" data-scroll-target="#exercise-03">Exercise 03:</a>
  <ul class="collapse">
  <li><a href="#exercise-3a-tuning-a-neural-network" id="toc-exercise-3a-tuning-a-neural-network" class="nav-link" data-scroll-target="#exercise-3a-tuning-a-neural-network">Exercise 3a: Tuning a neural network</a></li>
  <li><a href="#exercise-3b-creating-a-stack" id="toc-exercise-3b-creating-a-stack" class="nav-link" data-scroll-target="#exercise-3b-creating-a-stack">Exercise 3b: Creating a Stack</a></li>
  <li><a href="#exercise-3c-evaluating-the-stack" id="toc-exercise-3c-evaluating-the-stack" class="nav-link" data-scroll-target="#exercise-3c-evaluating-the-stack">Exercise 3c: Evaluating the stack</a>
  <ul class="collapse">
  <li><a href="#exercise-3c-i" id="toc-exercise-3c-i" class="nav-link" data-scroll-target="#exercise-3c-i">Exercise 3c i:</a></li>
  <li><a href="#exercise-3c-ii" id="toc-exercise-3c-ii" class="nav-link" data-scroll-target="#exercise-3c-ii">Exercise 3c ii:</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Problem Set 09</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="foreword" class="level1">
<h1>Foreword</h1>
<p>In this exercise session, we will consider some theoretical and practical aspects of neural networks. Neural networks are by now, probably the most commonly used models in Machine Learning Research and application, as they offer a highly versatile and well-performing approach for both, classification and regression tasks. However, as we have seen when considering models like XGBoost <em>with great performance comes great computational cost</em>. Training neural networks not only requires a lot of data to yield satisfactory results but can also take a long time to train, depending on the number of features and samples.</p>
<p><strong>Personal Opinion:</strong> Training neural networks in R is certainly possible, but not ideal. Most machine learning libraries and neural network architectures are far more accessible in scripting languages like Python, which encompass a much wider variety of development frameworks.</p>
</section>
<section id="exercises" class="level1">
<h1>Exercises</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brulee)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finetune)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bonsai)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stacks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exercise-01-theoretical-foundations" class="level2">
<h2 class="anchored" data-anchor-id="exercise-01-theoretical-foundations">Exercise 01: Theoretical foundations</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notation
</div>
</div>
<div class="callout-body-container callout-body">
<p>The notation used on this exercise sheet will be somewhat different from the notation in the lecture. However, I will try to explain every notational aspect as clearly as possible.</p>
</div>
</div>
<p>In the following two sub exercises, we will consider the neural network depicted below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="nn01.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Here,</p>
<ul>
<li><p><span class="math inline">\((x_1, x_2)^\top\in \mathbb{R}^2\)</span> denotes an input vector</p></li>
<li><p><span class="math inline">\(\{h_i^{(1)}\}_{i=1}^3\)</span> denote a hidden layer with each neuron defined by <span class="math display">\[ h_i^{(1)} := \sigma_1\left(\sum_{j=1}^{2}w_{ij}^{(1)} x_j + b_1\right),\tag{1}\]</span> where <span class="math inline">\(\sigma_1:\mathbb{R}\to\mathbb{R}\)</span> denotes an activation function, <span class="math inline">\(w_{i1}^{(1)},w_{i2}^{(1)}, b_1\in\mathbb{R},i=1,...,3\)</span> denote weights and a bias for the first layer.</p></li>
<li><p><span class="math inline">\(y_1\)</span> is the output of the neural network that is defined as <span class="math display">\[ y_1 = \sigma_2\left(\sum_{i=1}^{3}w_{i1}^{(2)}h_i^{(1)}+b_2\right),\tag{2}\]</span> where <span class="math inline">\(\sigma_2:\mathbb{R}\to\mathbb{R}\)</span> denotes another activation function, and <span class="math inline">\(w_{i1}^{(2)}, b_2\in\mathbb{R},i=1,...,3\)</span> denote weights and a bias for the second/final layer.</p></li>
</ul>
<section id="exercise-01a" class="level3">
<h3 class="anchored" data-anchor-id="exercise-01a">Exercise 01a:</h3>
<p>Assume that <span class="math inline">\(\sigma_1 = \sigma_2 = \mathrm{ReLU}\)</span>, i.e., <span class="math inline">\(x\mapsto \max\{0,x\}\)</span>. Set up the model equation for this neural network by expanding the term <span class="math inline">\(y_1\)</span>.</p>
</section>
<section id="exercise-01b" class="level3">
<h3 class="anchored" data-anchor-id="exercise-01b">Exercise 01b :</h3>
<p>The goal of this exercise is for you to implement and visualize the neural network above.</p>
<section id="exercise-01b-i" class="level4">
<h4 class="anchored" data-anchor-id="exercise-01b-i">Exercise 01b i:</h4>
<p>Write a function <code>nn</code> that represents the neural network of the previous exercise. It should take a vector <span class="math inline">\(x\in\mathbb{R}^2\)</span>, a weight matrix <span class="math inline">\(w1\in\mathbb{R}^{3\times 2}\)</span> used to calculate <span class="math inline">\(h_i^{(1)}\)</span>, a weight vector <span class="math inline">\(w2\in\mathbb{R}^3\)</span> used to calculate the term <span class="math inline">\(\sum_{i=1}^{3}w_{i1}^{(2)}h_i^{(1)}\)</span> and two bias terms <span class="math inline">\(b1,b2\in\mathbb{R}\)</span> as an input . The return value should be the output of the neural network we used in the previous exercises.</p>
</section>
<section id="exercise-01b-ii" class="level4">
<h4 class="anchored" data-anchor-id="exercise-01b-ii">Exercise 01b ii:</h4>
<p>Given the following weights, biases, and input matrix <code>x</code>, calculate the return value and plot the results using the <code>geom_tile()</code> function where the return value of the <code>nn</code> function is set to be the fill parameter.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You will have to use the <code>lapply</code> function to be able to apply the input matrix <code>x</code> to the function <code>nn</code>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>w1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>w2 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(x1,x2) <span class="sc">%&gt;%</span> as.matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exerice-01c" class="level3">
<h3 class="anchored" data-anchor-id="exerice-01c">Exerice 01c:</h3>
<p>We can generalize the neural network above in a way that the hidden layer has <span class="math inline">\(n\in\mathbb{N}\)</span> instead of <span class="math inline">\(3\)</span> neurons. Modify Equation (2), such that the hidden layer now has <span class="math inline">\(n\in\mathbb{N}\)</span> neurons! What are the benefits and drawbacks of adding additional neurons? Name one each.</p>
</section>
</section>
<section id="exercise-02-neural-networks---toy-examples" class="level2">
<h2 class="anchored" data-anchor-id="exercise-02-neural-networks---toy-examples">Exercise 02: Neural networks - toy examples</h2>
<p>For the following exercises, you can use the <code>contour_plot</code> function provided below, to plot the decision function of the specified model. Besides the model, you also have to specify the range of the data samples in order to get a full view of the decision function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>contour_plot <span class="ot">&lt;-</span><span class="cf">function</span>(model,axis_limit){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  x_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span>axis_limit,axis_limit,<span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span>axis_limit,axis_limit,<span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  x_grid <span class="ot">&lt;-</span> x_grid <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="fu">predict</span>(model, x_grid, <span class="at">type =</span> <span class="st">"prob"</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(x_grid, <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2)) <span class="sc">+</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">col =</span> label), <span class="at">alpha =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>, <span class="at">cex =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">z =</span> <span class="st">`</span><span class="at">.pred_1</span><span class="st">`</span>), <span class="at">breaks =</span> .<span class="dv">5</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>()<span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exerxise-02a" class="level3">
<h3 class="anchored" data-anchor-id="exerxise-02a">Exerxise 02a:</h3>
<p>Let us revisit the toy dataset we used on the last exercise sheet:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"ex01.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">label =</span> <span class="fu">factor</span>(y)) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>y)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(x1,x2, <span class="at">color =</span> label)) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Exercise_09_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="exercise-02a-i" class="level4">
<h4 class="anchored" data-anchor-id="exercise-02a-i">Exercise 02a i:</h4>
<p>Using our knowledge about SVMs, train an RBF-Kernel SVM on the data <code>data</code>, where <code>x1</code> and <code>x2</code> are fitted on <code>label</code>. You do not have to tune any parameters and can in fact use all the default values. For the resulting model, create a ROC-Curve, a confusion matrix, and with the help of the <code>contour_plot</code> function a plot visualizing the boundary.</p>
</section>
<section id="exercise-02a-ii" class="level4">
<h4 class="anchored" data-anchor-id="exercise-02a-ii">Exercise 02a ii:</h4>
<p>A simple interface within the <code>{tidymodels}</code> framework for training neural networks is provided by the <code>{brulee}</code> package.</p>
<p>Similar to all the models we trained before, we simply have to specify the model parameters and train our model using the <code>fit</code> function.</p>
<p>For this exercise, we are mainly interested in the following parameters:</p>
<ul>
<li><p><code>epochs</code>: An integer for the number of training iterations</p></li>
<li><p><code>hidden_units</code>: Can be either an integer or an integer vector. An integer indicates that only one hidden layer is used, while a vector specifies the number of layers by its length and the number of neurons by the values in the vector.</p></li>
<li><p><code>learn_rate</code>: A positive number indicating the step size for the optimization algorithm.</p></li>
</ul>
<p>For this exercise, we will not tune any parameters but instead try a specific architecture.</p>
<p>Set up a <code>mlp</code> model called <code>nnet_res</code> with the parameters <code>epochs = 200</code>, <code>hidden_units = c(2,4)</code>, and <code>learn_rate = 0.1</code>.</p>
<p>Calling <code>nnet_res</code> should then yield the following output:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Single Layer Neural Network Model Specification (unknown mode)

Main Arguments:
  hidden_units = c(2, 4)
  epochs = 100
  learn_rate = 0.1

Computational engine: nnet </code></pre>
</div>
</div>
<p>Set the engine to <code>"brulee"</code>, the mode to <code>"classification"</code>, and train the model using the <code>fit</code> function by fitting the variables <code>x1</code> and <code>x2</code> of the dataset <code>data</code> on the variable <code>label</code>. Calling the trained neural net <code>nnet_res</code> then returns an output similar to the one below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object

Multilayer perceptron

relu relu activation
c(2,4) hidden units,  28 model parameters
50 samples, 2 features, 2 classes 
class weights -1=1, 1=1 
weight decay: 0.001 
dropout proportion: 0 
batch size: 45 
learn rate: 0.1 
validation loss after 19 epochs: 0.712 </code></pre>
</div>
</div>
<p>Similar to the exercise above, create a Roc-Curve, confusion matrix and a contour plot of the decision function.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="Exercise_09_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="exercise-02a-iii" class="level4">
<h4 class="anchored" data-anchor-id="exercise-02a-iii">Exercise 02a iii:</h4>
<p>Compare the results of the models.</p>
</section>
</section>
<section id="exercise-02b" class="level3">
<h3 class="anchored" data-anchor-id="exercise-02b">Exercise 02b:</h3>
<p>Consider another dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>spirals <span class="ot">&lt;-</span> <span class="cf">function</span>(n, sd){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  theta <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">runif</span>(n,<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">2</span>))<span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>theta<span class="sc">+</span>pi</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  spiral1 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">x1 =</span> <span class="fu">cos</span>(theta)<span class="sc">*</span>r1 <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sd),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">x2 =</span> <span class="fu">sin</span>(theta)<span class="sc">*</span>r1 <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sd),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>,n)))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> <span class="sc">-</span>(<span class="dv">2</span><span class="sc">*</span>theta<span class="sc">+</span>pi)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  spiral2 <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">x1 =</span> <span class="fu">cos</span>(theta)<span class="sc">*</span>r2 <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sd),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">x2 =</span> <span class="fu">sin</span>(theta)<span class="sc">*</span>r2 <span class="sc">+</span> <span class="fu">rnorm</span>(n,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sd),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="dv">1</span>,n)))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">=</span> <span class="fu">rbind</span>(spiral1,spiral2)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span> <span class="fu">spirals</span>(<span class="dv">2000</span>, <span class="dv">1</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">color =</span> label)) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Exercise_09_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="exercise-02b-i" class="level4">
<h4 class="anchored" data-anchor-id="exercise-02b-i">Exercise 02b i:</h4>
<p>Repeat Exercise 02a i for this new dataset.</p>
</section>
<section id="exercise-02-b-ii" class="level4">
<h4 class="anchored" data-anchor-id="exercise-02-b-ii">Exercise 02 b ii:</h4>
<p>Repeat Exercise 02a ii for this new dataset.</p>
</section>
</section>
</section>
<section id="exercise-03" class="level2">
<h2 class="anchored" data-anchor-id="exercise-03">Exercise 03:</h2>
<p>In this last exercise, we want to extend our stacking model from Exercise Session 08, by replacing the simple classification tree with a neural network.</p>
<p>Below you can find the necessary preprocessing steps and model specifications for the random forest and XGBoost model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>credit_info <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"BankChurners.csv"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(credit_info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 10,127
Columns: 21
$ CLIENTNUM                &lt;int&gt; 768805383, 818770008, 713982108, 769911858, 7…
$ Attrition_Flag           &lt;chr&gt; "Existing Customer", "Existing Customer", "Ex…
$ Customer_Age             &lt;int&gt; 45, 49, 51, 40, 40, 44, 51, 32, 37, 48, 42, 6…
$ Gender                   &lt;chr&gt; "M", "F", "M", "F", "M", "M", "M", "M", "M", …
$ Dependent_count          &lt;int&gt; 3, 5, 3, 4, 3, 2, 4, 0, 3, 2, 5, 1, 1, 3, 2, …
$ Education_Level          &lt;chr&gt; "High School", "Graduate", "Graduate", "High …
$ Marital_Status           &lt;chr&gt; "Married", "Single", "Married", "Unknown", "M…
$ Income_Category          &lt;chr&gt; "$60K - $80K", "Less than $40K", "$80K - $120…
$ Card_Category            &lt;chr&gt; "Blue", "Blue", "Blue", "Blue", "Blue", "Blue…
$ Months_on_book           &lt;int&gt; 39, 44, 36, 34, 21, 36, 46, 27, 36, 36, 31, 5…
$ Total_Relationship_Count &lt;int&gt; 5, 6, 4, 3, 5, 3, 6, 2, 5, 6, 5, 6, 3, 5, 5, …
$ Months_Inactive_12_mon   &lt;int&gt; 1, 1, 1, 4, 1, 1, 1, 2, 2, 3, 3, 2, 6, 1, 2, …
$ Contacts_Count_12_mon    &lt;int&gt; 3, 2, 0, 1, 0, 2, 3, 2, 0, 3, 2, 3, 0, 3, 2, …
$ Credit_Limit             &lt;dbl&gt; 12691.0, 8256.0, 3418.0, 3313.0, 4716.0, 4010…
$ Total_Revolving_Bal      &lt;int&gt; 777, 864, 0, 2517, 0, 1247, 2264, 1396, 2517,…
$ Avg_Open_To_Buy          &lt;dbl&gt; 11914.0, 7392.0, 3418.0, 796.0, 4716.0, 2763.…
$ Total_Amt_Chng_Q4_Q1     &lt;dbl&gt; 1.335, 1.541, 2.594, 1.405, 2.175, 1.376, 1.9…
$ Total_Trans_Amt          &lt;int&gt; 1144, 1291, 1887, 1171, 816, 1088, 1330, 1538…
$ Total_Trans_Ct           &lt;int&gt; 42, 33, 20, 20, 28, 24, 31, 36, 24, 32, 42, 2…
$ Total_Ct_Chng_Q4_Q1      &lt;dbl&gt; 1.625, 3.714, 2.333, 2.333, 2.500, 0.846, 0.7…
$ Avg_Utilization_Ratio    &lt;dbl&gt; 0.061, 0.105, 0.000, 0.760, 0.000, 0.311, 0.0…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>credit_info_clean <span class="ot">&lt;-</span>credit_info <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Income_Category =</span> <span class="fu">factor</span>(Income_Category,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Unknown"</span>,<span class="st">"Less than $40K"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"$40K - $60K"</span>,<span class="st">"$60K - $80K"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"$80K - $120K"</span>,<span class="st">"$120K +"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">Education_Level =</span> <span class="fu">factor</span>(Education_Level,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Unknown"</span>, <span class="st">"Uneducated"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"High School"</span>, <span class="st">"College"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"Graduate"</span>,<span class="st">"Post-Graduate"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"Doctorate"</span>),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">CLIENTNUM =</span> <span class="fu">factor</span>(CLIENTNUM),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">Marital_Status =</span> <span class="fu">factor</span>(Marital_Status),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">Card_Category =</span> <span class="fu">factor</span>(Card_Category),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">Gender =</span> <span class="fu">factor</span>(Gender),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">Attrition_Flag =</span> <span class="fu">factor</span>(Attrition_Flag,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Inactive"</span>, <span class="st">"Active"</span>)),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_info_clean, <span class="at">strata =</span> Attrition_Flag)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>data_train <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>data_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(data_train, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>rec_ci <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Attrition_Flag <span class="sc">~</span>., <span class="at">data =</span> data_train) <span class="sc">%&gt;%</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(CLIENTNUM, <span class="at">new_role =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ordinalscore</span>(<span class="fu">all_ordered_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_factor_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>ci_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec_ci)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Setting up a control grid:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ctrl_grid <span class="ot">&lt;-</span> <span class="fu">control_stack_grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Training a random forest:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"classification"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>(),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">1000</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>ci_wf <span class="ot">&lt;-</span> ci_wf <span class="sc">%&gt;%</span> <span class="fu">add_model</span>(rf_model)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>rf_res <span class="ot">&lt;-</span> ci_wf <span class="sc">%&gt;%</span> </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(<span class="at">grid =</span> <span class="dv">10</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">resamples =</span> folds,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> ctrl_grid</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
</div>
</div>
<p><strong>Training a XGBoost-model:</strong></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Training the XGBoost model takes around 10-15 minutes.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>xgb_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>(),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(),         </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),                     </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fu">tune</span>()                          </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>cooked_rec <span class="ot">&lt;-</span> rec_ci <span class="sc">%&gt;%</span> prep <span class="sc">%&gt;%</span> <span class="fu">bake</span>(data_train) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"CLIENTNUM"</span>))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>xgb_grid <span class="ot">&lt;-</span><span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tree_depth</span>(),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min_n</span>(),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loss_reduction</span>(),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(<span class="fu">mtry</span>(), cooked_rec),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">learn_rate</span>(),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">30</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>ci_wf <span class="ot">&lt;-</span> ci_wf <span class="sc">%&gt;%</span> <span class="fu">update_model</span>(xgb_model)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>()</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="ot">&lt;-</span> ci_wf <span class="sc">%&gt;%</span> <span class="fu">tune_grid</span>(</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> xgb_grid,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> ctrl_grid</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exercise-3a-tuning-a-neural-network" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3a-tuning-a-neural-network">Exercise 3a: Tuning a neural network</h3>
<p>In this exercise, we want to consider some additional parameters and tune them before considering potential stack candidates for the stack.</p>
<ul>
<li><p><code>validation</code>: The proportion of the data randomly assigned to a validation set.</p></li>
<li><p><code>optimizer</code>: The optimizer used for training the model</p></li>
<li><p><code>momentum</code>: A number used to use historical gradient information during optimization.</p></li>
</ul>
<p>By setting the <code>validation</code> to <span class="math inline">\(0\)</span>, we set aside no data for a validation set, which is unnecessary in our case since we are performing cross-validation anyway and split the data already. The optimizer we will use is <code>"SGD"</code>, which stands for Stochastic Gradient Descent and is basically an optimized version of gradient descent, that introduces randomness to the training process. For the <code>"SGD"</code> optimizer, we can specify the momentum, that might help overcome local minima in the pursuit of finding the global minimum of our loss function.</p>
<p>Create a new <code>mlp</code> model called <code>nnet_model</code> and directly pass the parameters <code>epochs = 400</code>, <code>hidden_units = c(24,96)</code>, and <code>learn_rate = tune()</code>. Set the engine to “brulee” by using the <code>set_engine</code> function and pass <code>validation = 0</code>, <code>optimzer = "SGD"</code>, <code>momentum = tune()</code> as additional arguments. Finally, set the mode to <code>"classification"</code>, update the model in the workflow, and tune the model using the <code>tune_grid</code> function with parameters <code>resamples = folds</code>, <code>grid = 20</code>, and <code>control = ctrl_grid</code>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This model can also take around 10-15 minutes to train</p>
</div>
</div>
</section>
<section id="exercise-3b-creating-a-stack" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3b-creating-a-stack">Exercise 3b: Creating a Stack</h3>
<p>Once you have successfully tuned the neural net, set up the stack and fit the members similar to Exercise 3b on Sheet 08. make sure you use the <code>metric = metric_set(pr_auc)</code> and <code>mixture = 0.9</code> option.</p>
</section>
<section id="exercise-3c-evaluating-the-stack" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3c-evaluating-the-stack">Exercise 3c: Evaluating the stack</h3>
<p>In this last exercise, we want to evaluate our stack and in order to do so, we first need to create predictions from our test dataset. The following code snippet creates predictions based on the test set and saves the probabilities of the sample belonging to either class in a new column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>stack_pred <span class="ot">&lt;-</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  data_test <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(ci_stack, ., <span class="at">type =</span> <span class="st">"prob"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exercise-3c-i" class="level4">
<h4 class="anchored" data-anchor-id="exercise-3c-i">Exercise 3c i:</h4>
<p>Given the <code>stack_pred</code> tibble, create a ROC- and PR-Curve similar to Exercise 2d on Exercise Sheet 06.</p>
</section>
<section id="exercise-3c-ii" class="level4">
<h4 class="anchored" data-anchor-id="exercise-3c-ii">Exercise 3c ii:</h4>
<p>Similar to Exercise 2e on Exercise Sheet 06 and create a confusion matrix. How does the model hold up?</p>
</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>